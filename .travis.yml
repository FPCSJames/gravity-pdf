os: linux

language: shell

services:
  - docker

addons:
  apt:
    sources:
      - sourceline: 'deb https://dl.yarnpkg.com/debian/ stable main'
        key_url: 'https://dl.yarnpkg.com/debian/pubkey.gpg'
      - google-chrome
    packages:
      - docker-ce
      - yarn
      - google-chrome-stable

cache:
  yarn: true
  apt: true
  directories:
    - $HOME/.composer/cache
    - $HOME/.npm
    - $HOME/.nvm/.cache

env:
  global:
    - WP_DEVELOP_DIR: ./wordpress
    - INSTALL_COMPOSER: 0
    - INSTALL_WORDPRESS: true

before_install:
  - nvm install --lts
  - yarn prebuild
  - |
    if [[ "$INSTALL_WORDPRESS" = "true" ]]; then
      # Upgrade docker-compose.
      sudo rm /usr/local/bin/docker-compose
      curl -sL https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` > docker-compose
      chmod +x docker-compose
      sudo mv docker-compose /usr/local/bin
    fi

install:
  # Build Gravity PDF
  - yarn build:production
  - |
    if [[ "$INSTALL_WORDPRESS" = "true" ]]; then
      bash ./bin/install.sh
      npm run env:install:phpunit
    fi
  - |
    if [[ "$INSTALL_COMPOSER" != "0" ]]; then
      bash ./bin/download-wordpress.sh
      bash ./bin/install-wordpress.sh
      npm run env connect
      if [[ "$INSTALL_COMPOSER" = "2" ]]; then
        npm run env docker-run -- php composer install --no-dev
      else
        npm run env docker-run -- php composer install
      fi
    fi

jobs:
  allow_failures:
    - name: PHP 7.4 unit tests

  include:
    - name: E2E Testing
      script:
        - npm run test:e2e:headless

    - stage: Deploy
      name: Package and Push to WordPress.org
      env: INSTALL_WORDPRESS=false LOCAL_PHP=5.6-fpm INSTALL_COMPOSER=2
      script:
        - |
          bash ./bin/package.sh $TRAVIS_TAG $TRAVIS_BRANCH &&
          bash ./bin/deploy.sh
      if: tag IS present

after_success:
  - |
    if [[ "$LOCAL_PHP_XDEBUG" = "true" ]]; then
      bash <(curl -s https://codecov.io/bash);
    fi
