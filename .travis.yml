language: generic

services:
  - docker

#branches:
#  only:
#    - master
#    - development
#    - /^\d+\.\d+(\.\d+)?(-\S*)?$/

addons:
  apt:
    sources:
      - sourceline: 'deb https://dl.yarnpkg.com/debian/ stable main'
        key_url: 'https://dl.yarnpkg.com/debian/pubkey.gpg'
      - google-chrome
    packages:
      - docker-ce
      - yarn
      - google-chrome-stable

cache:
  yarn: true
  apt: true
  directories:
    - $HOME/.composer/cache
    - $HOME/.npm
    - $HOME/.nvm/.cache

env:
  global:
    - WP_DEVELOP_DIR: ./wordpress
    - INSTALL_COMPOSER: 0
    - INSTALL_WORDPRESS: true

before_install:
  - nvm install --lts
  - yarn prebuild
  - |
    if [[ "$INSTALL_WORDPRESS" = "true" ]]; then
      # Upgrade docker-compose.
      sudo rm /usr/local/bin/docker-compose
      curl -sL https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` > docker-compose
      chmod +x docker-compose
      sudo mv docker-compose /usr/local/bin
    fi

install:
  # Build Gravity PDF
  - gulp && yarn build
  - |
    if [[ "$INSTALL_WORDPRESS" = "true" ]]; then
      bash ./bin/install.sh
      npm run env:install:phpunit
    fi
  - |
    if [[ "$INSTALL_COMPOSER" != "0" ]]; then
      bash ./bin/download-wordpress.sh
      bash ./bin/install-wordpress.sh
      if [[ "$INSTALL_COMPOSER" = "2" ]]; then
        npm run env docker-run -- php composer install --no-dev
      else
        npm run env docker-run -- php composer install
      fi
    fi

jobs:
  fast_finish: true
  allow_failures:
    - name: PHP 7.4 unit tests

  include:
    - stage: Linting
      name: PHP Linting
      env: INSTALL_WORDPRESS=false INSTALL_COMPOSER=1
      script:
        - |
          docker-compose run --rm php composer format &&
          docker-compose run --rm php composer lint:errors

    - name: PHP Compatibility
      env: INSTALL_WORDPRESS=false INSTALL_COMPOSER=2
      script:
        - docker-compose run --rm php composer compat

    - name: JS Linting
      env: INSTALL_WORDPRESS=false
      script:
        - npm run lint:js

    - stage: Unit Testing
      name: PHP 7.3 unit tests
      env: LOCAL_PHP=7.3-fpm
      script:
        - |
          npm run test:php && npm run test:php --group ajax &&
          npm run test:php:multisite && npm run test:php:multisite --group ajax

    - name: PHP 7.2 unit tests
      env: LOCAL_PHP=7.2-fpm
      script:
        - |
          npm run test:php &&
          npm run test:php --group ajax

    - name: PHP 7.1 unit tests
      env: LOCAL_PHP=7.1-fpm
      script:
        - |
          npm run test:php &&
          npm run test:php --group ajax

    - name: PHP 7.0 unit tests
      env: LOCAL_PHP=7.0-fpm
      script:
        - |
          npm run test:php &&
          npm run test:php --group ajax

    - name: PHP 5.6 unit tests
      env: LOCAL_PHP=5.6-fpm
      script:
        - |
          npm run test:php &&
          npm run test:php --group ajax

    - name: PHP 7.4 unit tests
      env: LOCAL_PHP=7.4-fpm
      script:
        - |
          npm run test:php &&
          npm run test:php --group ajax

    - stage: End to End Testing
      name: E2E Testing
      script:
        - npm run test:e2e:headless

    - stage: Code Coverage
      name: JS and PHP Coverage
      env: LOCAL_PHP=7.3-fpm LOCAL_PHP_XDEBUG=true
      script:
        - |
          npm run test:coverage &&
          npm run test:php --coverage-clover=tmp/coverage/report-xml/php-coverage1.xml &&
          npm run test:php --coverage-clover=tmp/coverage/report-xml/php-coverage2.xml --group ajax

after_success:
  - |
    if [[ "$LOCAL_PHP_XDEBUG" = "true" ]]; then
      bash <(curl -s https://codecov.io/bash);
    fi